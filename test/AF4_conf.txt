
#
# commands for 4 node
#
# зайти в ОС через консоль под login/pass - pt/positive
#
# все команды выполняются из-под root
sudo su
# настраиваем интерфейс управления
ifconfig eth0 up
ip a add 192.168.0.174/255.255.255.0 dev eth0
ip route add default via 192.168.0.1
#
# подключаемся по SSH к серверу на MGMT интерфейс: 192.168.0.174:22013
# и выполняем команды ниже
#
sudo su
запускаем tmux
# назначаем VIP-ы для manage, monitoring, border
wsc -c "vip set monitoring 192.168.0.171"
wsc -c "vip set manage 192.168.0.171"
wsc -c "vip set border 192.168.0.171"
# настройка интерфейса MGMT
wsc -c "dhcp set routers false"
wsc -c "if set eth0 inet_method static inet_address 192.168.0.174 inet_netmask 255.255.255.0 inet_gateway 192.168.0.1"
# настройка интерфейса CLUSTER
wsc -c "if set eth1 inet_method static inet_address 172.16.10.13 inet_netmask 255.255.255.248"
wsc -c "if set eth1 role CLUSTER"
# настройка интерфейса WAN
wsc -c "if set eth2 inet_method static inet_address 10.10.10.10 inet_netmask 255.255.255.0"
wsc -c "if set eth2 role WAN"
wsc -c "if set eth2 role LAN"
# Настройка DNS
echo "nameserver 8.8.8.8" >> /etc/resolv.conf
# Настройка NTP
wsc -c "dhcp set ntp_servers false"
wsc -c "ntp add time.google.com"
# задаем hostname
hostnamectl set-hostname ptaf-vm4
echo "127.0.1.1 ptaf-vm4" >> /etc/hosts
echo "172.16.10.13 ptaf-vm4" >> /etc/hosts
# задаем Timezone
wsc -c "timezone Asia/Dubai"

#
# после этой команды возможно прервется сеть, необходимо переподключиться в "sudo tmux a" и убедиться что commit прошел успешно и продолжить установку
#
wsc -c "config commit"
exit

#
# commands for 3 node
#
# зайти в ОС через консоль под login/pass - pt/positive
#
# все команды выполняются из-под root
sudo su
# настраиваем интерфейс управления
ifconfig eth0 up
ip a add 192.168.0.173/255.255.255.0 dev eth0
ip route add default via 192.168.0.1
#
# подключаемся по SSH к серверу на MGMT интерфейс: 192.168.0.173:22013
# и выполняем команды ниже
#
sudo su
запускаем tmux
# назначаем VIP-ы для manage, monitoring, border
wsc -c "vip set monitoring 192.168.0.171"
wsc -c "vip set manage 192.168.0.171"
wsc -c "vip set border 192.168.0.171"
# настройка интерфейса MGMT
wsc -c "dhcp set routers false"
wsc -c "if set eth0 inet_method static inet_address 192.168.0.173 inet_netmask 255.255.255.0 inet_gateway 192.168.0.1"
# настройка интерфейса CLUSTER
wsc -c "if set eth1 inet_method static inet_address 172.16.10.12 inet_netmask 255.255.255.248"
wsc -c "if set eth1 role CLUSTER"
wsc -c "if set eth0 role WAN"
wsc -c "if set eth0 role LAN"
# Настройка DNS
echo "nameserver 8.8.8.8" >> /etc/resolv.conf
# Настройка NTP
wsc -c "dhcp set ntp_servers false"
wsc -c "ntp add time.google.com"
# задаем hostname
hostnamectl set-hostname ptaf-vm3
echo "127.0.1.1 ptaf-vm3" >> /etc/hosts
echo "172.16.10.12 ptaf-vm3" >> /etc/hosts
# задаем Timezone
wsc -c "timezone Asia/Dubai"

#
# после этой команды возможно прервется сеть, необходимо переподключиться в "sudo tmux a" и убедиться что commit прошел успешно и продолжить установку
#
wsc -c "config commit"
exit

#
# commands for 2 node
#
# зайти в ОС через консоль под login/pass - pt/positive
#
# все команды выполняются из-под root
sudo su
# настраиваем интерфейс управления
ifconfig eth0 up
ip a add 192.168.0.172/255.255.255.0 dev eth0
ip route add default via 192.168.0.1
#
# подключаемся по SSH к серверу на MGMT интерфейс: 192.168.0.172:22013
# и выполняем команды ниже
#
sudo su
запускаем tmux
# назначаем VIP-ы для manage, monitoring, border
wsc -c "vip set monitoring 192.168.0.171"
wsc -c "vip set manage 192.168.0.171"
wsc -c "vip set border 192.168.0.171"
# настройка интерфейса MGMT
wsc -c "dhcp set routers false"
wsc -c "if set eth0 inet_method static inet_address 192.168.0.172 inet_netmask 255.255.255.0 inet_gateway 192.168.0.1"
# настройка интерфейса CLUSTER
wsc -c "if set eth1 inet_method static inet_address 172.16.10.11 inet_netmask 255.255.255.248"
wsc -c "if set eth1 role CLUSTER"
wsc -c "if set eth0 role WAN"
wsc -c "if set eth0 role LAN"
# Настройка DNS
echo "nameserver 8.8.8.8" >> /etc/resolv.conf
# Настройка NTP
wsc -c "dhcp set ntp_servers false"
wsc -c "ntp add time.google.com"
# задаем hostname
hostnamectl set-hostname ptaf-vm2
echo "127.0.1.1 ptaf-vm2" >> /etc/hosts
echo "172.16.10.11 ptaf-vm2" >> /etc/hosts
# задаем Timezone
wsc -c "timezone Asia/Dubai"

#
# после этой команды возможно прервется сеть, необходимо переподключиться в "sudo tmux a" и убедиться что commit прошел успешно и продолжить установку
#
wsc -c "config commit"
exit

#
# commands for 1 node
#
# зайти в ОС через консоль под login/pass - pt/positive
#
# все команды выполняются из-под root
sudo su
# настраиваем интерфейс управления
ifconfig eth0 up
ip a add 192.168.0.171/255.255.255.0 dev eth0
ip route add default via 192.168.0.1
#
# подключаемся по SSH к серверу на MGMT интерфейс: 192.168.0.171:22013
# и выполняем команды ниже
#
sudo su
запускаем tmux
# назначаем VIP-ы для manage, monitoring, border
wsc -c "vip set monitoring 192.168.0.171"
wsc -c "vip set manage 192.168.0.171"
wsc -c "vip set border 192.168.0.171"
# настройка интерфейса MGMT
wsc -c "dhcp set routers false"
wsc -c "if set eth0 inet_method static inet_address 192.168.0.171 inet_netmask 255.255.255.0 inet_gateway 192.168.0.1"
# настройка интерфейса CLUSTER
wsc -c "if set eth1 inet_method static inet_address 172.16.10.10 inet_netmask 255.255.255.248"
wsc -c "if set eth1 role CLUSTER"
wsc -c "if set eth0 role WAN"
wsc -c "if set eth0 role LAN"
# Настройка DNS
echo "nameserver 8.8.8.8" >> /etc/resolv.conf
# Настройка NTP
wsc -c "dhcp set ntp_servers false"
wsc -c "ntp add time.google.com"
# задаем hostname
hostnamectl set-hostname ptaf-vm1
# задаем Timezone
wsc -c "timezone Asia/Dubai"

#
# после этой команды возможно прервется сеть, необходимо переподключиться в "sudo tmux a" и убедиться что commit прошел успешно и продолжить установку
#
wsc -c "config commit"
echo "127.0.1.1 ptaf-vm1" >> /etc/hosts
echo "172.16.10.13 ptaf-vm4" >> /etc/hosts
echo "172.16.10.12 ptaf-vm3" >> /etc/hosts
echo "172.16.10.11 ptaf-vm2" >> /etc/hosts
echo "172.16.10.10 ptaf-vm1" >> /etc/hosts


# настройка роли узла(ов)
# Важно! пароль должен совпадать. Если запустили с неправильным то нужно удалять и добавлять по новой "inventory node del <name> force"
# Узлов с ролью clickhouse должно быть четное число!
wsc -c "inventory node add ptaf-vm1"
wsc -c 'inventory node set ptaf-vm1 cluster_ip 172.16.10.10 role master,worker-backend,postgresql,rabbitmq,minio,clickhouse port 22013 user_name pt user_password admin@123 sudo_password admin@123'
wsc -c "inventory node add ptaf-vm2"
wsc -c 'inventory node set ptaf-vm2 cluster_ip 172.16.10.11 role master,worker-backend,postgresql,rabbitmq,minio,clickhouse port 22013 user_name pt user_password admin@124 sudo_password admin@124'
wsc -c "inventory node add ptaf-vm3"
wsc -c 'inventory node set ptaf-vm3 cluster_ip 172.16.10.12 role master,worker-backend,postgresql,rabbitmq,minio port 22013 user_name pt user_password admin@125 sudo_password admin@125'
wsc -c "inventory node add ptaf-vm4"
wsc -c 'inventory node set ptaf-vm4 cluster_ip 172.16.10.13 role worker-traffic port 22013 user_name pt user_password admin@125 sudo_password admin@125'
wsc -c "inventory check"
wsc -c "inventory node list"


# установка инфраструктуры
/var/pt/infra/current/install.sh
# установка Grafana
/var/pt/infra/current/install.sh --action=add_monitoring
# установка AF
/var/pt/ptaf-deploy/current/install.sh
#
#
# если установка завершилась без ошибок, то будет failed = 0
# подключаемся в UI под login/password - admin/positive и запрашиваем лицензию
# https://192.168.0.171
# Grafana доступна по ссылке ниже, login/password - admin/admin
# https://192.168.0.171:3000
