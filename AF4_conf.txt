
#
# commands for 3 node
#
# зайти в ОС через консоль под login/pass - pt/positive
#
# все команды выполняются из-под root
sudo su
# настраиваем интерфейс управления
ifconfig ens18 up
ip a add 192.168.88.173/255.255.255.0 dev ens18
ip route add default via 192.168.88.1
#
# подключаемся по SSH к серверу на MGMT интерфейс: 192.168.88.173:22013
# и выполняем команды ниже
#
sudo su
запускаем tmux
# назначаем VIP-ы для manage, monitoring, border
wsc -c "vip set monitoring 192.168.88.170"
wsc -c "vip set manage 192.168.88.170"
wsc -c "vip set border 192.168.88.170"
# настройка интерфейса WAN
wsc -c "dhcp set routers false"
wsc -c "if set ens18 inet_method static inet_address 192.168.88.173 inet_netmask 255.255.255.0 inet_gateway 192.168.88.1"
wsc -c "if set ens18 role WAN"
# настройка интерфейса CLUSTER
wsc -c "if set ens19 inet_method static inet_address 172.16.10.12 inet_netmask 255.255.255.0"
wsc -c "if set ens19 role CLUSTER"
wsc -c "if set ens18 role LAN"
# Настройка DNS
echo "nameserver 8.8.8.8" > /etc/resolv.conf
echo "nameserver 1.1.1.1" >> /etc/resolv.conf
echo "nameserver 2.2.2.2" >> /etc/resolv.conf
# Настройка NTP
wsc -c "dhcp set ntp_servers false"
wsc -c "ntp add time.google.com"
# задаем hostname
hostnamectl set-hostname ptaf-vm3
echo "127.0.0.1 localhost" > /etc/hosts
echo "127.0.1.1 ptaf-vm3" >> /etc/hosts
echo "172.16.10.12 ptaf-vm3" >> /etc/hosts
# задаем Timezone
wsc -c "timezone Europe/Moscow"

#
# после этой команды возможно прервется сеть, необходимо переподключиться в "sudo tmux a" и убедиться что commit прошел успешно и продолжить установку
#
wsc -c "config commit"
exit

#
# commands for 2 node
#
# зайти в ОС через консоль под login/pass - pt/positive
#
# все команды выполняются из-под root
sudo su
# настраиваем интерфейс управления
ifconfig ens18 up
ip a add 192.168.88.172/255.255.255.0 dev ens18
ip route add default via 192.168.88.1
#
# подключаемся по SSH к серверу на MGMT интерфейс: 192.168.88.172:22013
# и выполняем команды ниже
#
sudo su
запускаем tmux
# назначаем VIP-ы для manage, monitoring, border
wsc -c "vip set monitoring 192.168.88.170"
wsc -c "vip set manage 192.168.88.170"
wsc -c "vip set border 192.168.88.170"
# настройка интерфейса WAN
wsc -c "dhcp set routers false"
wsc -c "if set ens18 inet_method static inet_address 192.168.88.172 inet_netmask 255.255.255.0 inet_gateway 192.168.88.1"
wsc -c "if set ens18 role WAN"
# настройка интерфейса CLUSTER
wsc -c "if set ens19 inet_method static inet_address 172.16.10.11 inet_netmask 255.255.255.0"
wsc -c "if set ens19 role CLUSTER"
wsc -c "if set ens18 role LAN"
# Настройка DNS
echo "nameserver 8.8.8.8" > /etc/resolv.conf
echo "nameserver 1.1.1.1" >> /etc/resolv.conf
echo "nameserver 2.2.2.2" >> /etc/resolv.conf
# Настройка NTP
wsc -c "dhcp set ntp_servers false"
wsc -c "ntp add time.google.com"
# задаем hostname
hostnamectl set-hostname ptaf-vm2
echo "127.0.0.1 localhost" > /etc/hosts
echo "127.0.1.1 ptaf-vm2" >> /etc/hosts
echo "172.16.10.11 ptaf-vm2" >> /etc/hosts
# задаем Timezone
wsc -c "timezone Europe/Moscow"

#
# после этой команды возможно прервется сеть, необходимо переподключиться в "sudo tmux a" и убедиться что commit прошел успешно и продолжить установку
#
wsc -c "config commit"
exit

#
# commands for 1 node
#
# зайти в ОС через консоль под login/pass - pt/positive
#
# все команды выполняются из-под root
sudo su
# настраиваем интерфейс управления
ifconfig ens18 up
ip a add 192.168.88.171/255.255.255.0 dev ens18
ip route add default via 192.168.88.1
#
# подключаемся по SSH к серверу на MGMT интерфейс: 192.168.88.171:22013
# и выполняем команды ниже
#
sudo su
запускаем tmux
# назначаем VIP-ы для manage, monitoring, border
wsc -c "vip set monitoring 192.168.88.170"
wsc -c "vip set manage 192.168.88.170"
wsc -c "vip set border 192.168.88.170"
# настройка интерфейса WAN
wsc -c "dhcp set routers false"
wsc -c "if set ens18 inet_method static inet_address 192.168.88.171 inet_netmask 255.255.255.0 inet_gateway 192.168.88.1"
wsc -c "if set ens18 role WAN"
# настройка интерфейса CLUSTER
wsc -c "if set ens19 inet_method static inet_address 172.16.10.10 inet_netmask 255.255.255.0"
wsc -c "if set ens19 role CLUSTER"
wsc -c "if set ens18 role LAN"
# Настройка DNS
echo "nameserver 8.8.8.8" > /etc/resolv.conf
echo "nameserver 1.1.1.1" >> /etc/resolv.conf
echo "nameserver 2.2.2.2" >> /etc/resolv.conf
# Настройка NTP
wsc -c "dhcp set ntp_servers false"
wsc -c "ntp add time.google.com"
# задаем hostname
hostnamectl set-hostname ptaf-vm1
# задаем Timezone
wsc -c "timezone Europe/Moscow"

#
# после этой команды возможно прервется сеть, необходимо переподключиться в "sudo tmux a" и убедиться что commit прошел успешно и продолжить установку
#
wsc -c "config commit"
echo "127.0.0.1 localhost" > /etc/hosts
echo "127.0.1.1 ptaf-vm1" >> /etc/hosts
echo "172.16.10.12 ptaf-vm3" >> /etc/hosts
echo "172.16.10.11 ptaf-vm2" >> /etc/hosts
echo "172.16.10.10 ptaf-vm1" >> /etc/hosts


# настройка роли узла(ов)
# Важно! пароль должен совпадать. Если запустили с неправильным то нужно удалять и добавлять по новой "inventory node del <name> force"
# Узлов с ролью clickhouse должно быть четное число!
wsc -c "inventory node add ptaf-vm1"
wsc -c 'inventory node set ptaf-vm1 cluster_ip 172.16.10.10 role master,worker-backend,postgresql,rabbitmq,minio,clickhouse,worker-traffic port 22013 user_name pt user_password P@ssw0rd sudo_password P@ssw0rd'
wsc -c "inventory node add ptaf-vm2"
wsc -c 'inventory node set ptaf-vm2 cluster_ip 172.16.10.11 role master,worker-backend,postgresql,rabbitmq,minio,clickhouse,worker-traffic port 22013 user_name pt user_password P@ssw0rd sudo_password P@ssw0rd'
wsc -c "inventory node add ptaf-vm3"
wsc -c 'inventory node set ptaf-vm3 cluster_ip 172.16.10.12 role master,worker-backend,postgresql,rabbitmq,minio,worker-traffic port 22013 user_name pt user_password P@ssw0rd sudo_password P@ssw0rd'
wsc -c "inventory check"
wsc -c "inventory node list"


# установка инфраструктуры
/var/pt/infra/current/install.sh
# установка Grafana
/var/pt/infra/current/install.sh --action=add_monitoring
# установка AF
/var/pt/ptaf-deploy/current/install.sh
#
#
# если установка завершилась без ошибок, то будет failed = 0
# подключаемся в UI под login/password - admin/positive и запрашиваем лицензию
# https://192.168.88.170
# Grafana доступна по ссылке ниже, login/password - admin/admin
# https://192.168.88.170:3000
