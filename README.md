## Cкрипт по автоматической установке кластера AF (до 18 нод)

Скрипт позволяет разворачивать кластер PTAF PRO автоматически из большого количества нод и не прописывать всё руками в wsc.
Как работает:
Создаётся плейбук ансибл, который можно запустить на первой базовой ноде PTAF PRO. Он выполнит команды настройки wsc на всех нодах и подготовит кластер к установке AF PRO

Изменения в версии 2.3:
1. Исправлена запись 127.0.1.1 hostname в /etc/hosts
2. Исправлено поведение, когда на base-worker есть только mgmt и cluster, на мгмт вешается ван и лан

Изменения в версии 2.2:
1. Исправлена ошибка, когда на базовой ноде есть WAN но нет LAN, то роль LAN не добавлялась, сейчас роль LAN добавляется на все ноды корректно
2. Добавлена возможность отключить cloud-init (38я строка в excel)

Изменения  в версии 2.1:
1. Добавил возможность заводить больше 9 нод (до 18)
2. Добавил для каждой ноды возможность выбирать, где будет default gw
3. Теперь можно написать названия интерфейсов и в командах будут корректные названия
4. Добавлено проставление роли LAN к интерфейсу с ролью LAN 
5. Автоматическое добавление обязательной роли LAN к интерфейсу с ролью WAN, если нет отдельного интерфейса с ролью LAN на воркерах
6. Поправлено дублирование кластерного адреса первой ноды в etc/hosts
7. Если WAN не найден на базовой ноде, автоматом добавляем роль WAN к интерфейсу с ролью LAN, если такого нет, то к MGMT добавляется роль WAN и LAN
8. Автоматически собирается инвентори и плейбук ансибл, который позволяет развернуть кластер с первой базовой ноды. Нужно закинуть их на сервер, активировать виртуальную среду и запустить ансибл (скрипт подскажет, что делать)

## How to:
1. Заполнить AF4_conf.xlsx без изменения названия
2. Запустить скрипт (можно из exe)
3. На выходе будет 3 файла: 
   - Текстовый файл для ручной установки кластера как обычно (AF4_conf.txt).
   - Файл playbook.yaml со скриптами конфигурирования wsc и других параметров
   - Файл inventory.yaml c информацией о хостах кластера 

4. На нодах настраиваем кластерные интерфейсы как самые стабильные и не изменяемые, по ним и будет подключаться ансибл
5. На первую базовую ноду закидываем файлики playbook.yaml и inventory.yaml
6. Активируем виртуальную среду для возможности запуска предустановленного из коробки ansible:

```source /opt/ptaf/pywsc/bin/activate```

7. Запускаем ансибл плейбук для конфигурирования wsc на всех нодах, последним действием будет wsc -c "config commit", после которого ssh у ансибла может отвалиться и выполнение прервётся. Нужно будет просто зайти на ноды и выполнить config commit повторно.

```ansible-playbook -i inventory.yaml playbook.yaml```

8. Деактивируем виртуальную среду:

```deactivate```

9. Проверяем настройки wsc и запускаем установку инфры, мониторинга и деплой как обычно.
